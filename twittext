#!/usr/bin/env python
#-*- coding: utf-8 -*-

##################################################
# Twittext
# - http://www.techno-st.net/wiki/Twittext
##################################################

import twitter
import curses
import curses.wrapper
import curses.textpad
import locale
import signal

# config file
from config import *

def start(stdcur):
    (Y, X) = stdcur.getmaxyx()

    # inputwin = curses.newwin(1, X, 0, 7)
    # textbox = curses.textpad.Textbox(inputwin)

    while True:
        show_timeline(stdcur, Y, X)

        # postmsg = textbox.edit()
        curses.echo()
        postmsg = stdcur.getstr(0, 7)
        stdcur.clear()
        curses.noecho()
    
        if not postmsg == "":
            ret = api.PostUpdate(postmsg.decode("utf-8"))

def show_timeline(stdcur, Y, X):
    tl = api.GetFriendsTimeline(count = (Y - 2))
    
    stdcur.addstr(0, 0, "wayd?: ")

    header = " (@%s) [Twittext] =" % USER
    stdcur.addstr(
        1, 0,
        "=" * (X - len(header)) + header)
    
    i = 2
    for s in tl:
        status = "[%7s] %s" % (
            s.user.screen_name[0:7], s.text)
        stdcur.addnstr(i, 0, status.encode("utf-8"), X)
        i += 1
    
    stdcur.refresh()

def quit_me(signum, frame):
    exit()

signal.signal(signal.SIGINT, quit_me)
locale.setlocale(locale.LC_ALL, "")
api = twitter.Api(username = USER, password = PASS)

if(float(twitter.__version__[:3]) >= 0.6):
    api.SetCacheTimeout(10)
    #api.SetSource("Twitext")

curses.wrapper(start)
