#!/usr/bin/env python
#-*- coding: utf-8 -*-

##################################################
# Twittext
# - http://www.techno-st.net/wiki/Twittext
##################################################

import twitter
import curses
import curses.wrapper
import curses.textpad
import locale
import signal
import urllib2

# config file
from config import *

def start(stdcur):
    (Y, X) = stdcur.getmaxyx()
    stdcur.timeout(DELAY)
    curses.use_default_colors()

    while True:
        try:
            tl = api.GetFriendsTimeline(count = (Y - 2))
        except urllib2.HTTPError, e:
            if e.code == 401:
                curses.endwin()
                print "Error: Authentication Failed"
                exit()
            elif e.code / 100 == 5:
                stdcur.addstr(1, 0, "[Twitter Error (%d)]" % e.code)
                continue
            else:
                curses.endwin()
                print "Error: %s", e
                exit()
        
        show_timeline(tl, stdcur, Y, X)

        curses.noecho()
        curses.curs_set(0)
        c = stdcur.getch(0, 7)
        
        if c == curses.KEY_DOWN:
            stdcur.addstr(0, 7, " " * (X - 8))
            stdcur.move(2, 0)

            while True:
                (ny, nx) = stdcur.getyx()
                selstr = stdcur.instr(ny, 0, X)
                stdcur.addstr(ny, 0, selstr, curses.A_STANDOUT)
                c = stdcur.getch()

                if c == curses.KEY_DOWN:
                    if ny < Y - 1: v = 1
                    else: v = 0
                elif c == curses.KEY_UP:
                    if ny > 2: v = -1
                    else: v = 0
                elif c == 0x72 or c == 0x0a or c == curses.KEY_ENTER: # r, Enter
                    curses.echo()
                    stdcur.addstr(0, 0, "Reply: ")

                    target = tl[ny - 2]
                    reply_to = target.id
                    postmsg = "@%s " % target.user.screen_name
                    curses.curs_set(1)
                    stdcur.addstr(0, 7, postmsg)
                    postmsg += stdcur.getstr(0, 7 + len(postmsg)).decode('utf-8')
                    break
                elif c == 0x1b: # Esc
                    postmsg = None
                    break
                else:
                    continue

                selstr = stdcur.instr(ny, 0, X)
                stdcur.addstr(ny, 0, selstr, curses.A_NORMAL)
                stdcur.move(ny + v, 0)
        elif c == 0x0a or c == curses.KEY_ENTER: # Enter
            curses.echo()
            curses.curs_set(1)
            stdcur.addstr(" " * (X - 8))
            postmsg = stdcur.getstr(0, 7).decode('utf-8')
        elif c == 0x71: # q
            exit()
        else:
            postmsg = None
            continue
            
        stdcur.clear()
        curses.noecho()
        
        if not postmsg == None or postmsg == "":
            if postmsg[0] == '@':
                ret = api.PostUpdate(postmsg, reply_to)
            else:
                ret = api.PostUpdate(postmsg)

def show_timeline(tl, stdcur, Y, X):    
    stdcur.addstr(0, 0, "wayd?: ")
    stdcur.addstr(" " * (X - 8), curses.A_STANDOUT)

    header = " (@%s) [Twittext] =" % USER
    stdcur.addstr(
        1, 0,
        "=" * (X - len(header)) + header)
    
    i = 2
    for s in tl:
        status = "[%7s] %s" % (
            s.user.screen_name[0:7], s.text)
        stdcur.addnstr(i, 0, status.encode("utf-8"), X)
        i += 1
    
    stdcur.refresh()

def quit_me(signum = None, frame = None):
    exit()

signal.signal(signal.SIGINT, quit_me)
locale.setlocale(locale.LC_ALL, "")
api = twitter.Api(username = USER, password = PASS)

if(float(twitter.__version__[:3]) >= 0.6):
    api.SetCacheTimeout(10)
    #api.SetSource("Twitext")

curses.wrapper(start)
